# Mx Epoch Proxy - System Specification

## 1. Overview
**Mx Epoch Proxy** is a high-performance proxy server designed for the MultiversX blockchain ecosystem. Its primary function is **Smart Data Routing** across multiple observer squads. Instead of simple load balancing, it intelligently directs requests to the specific observer squad that holds the historical data (based on Block Nonce or Epoch) required to fulfill the request.

It sits between client applications (like dApps or indexers) and MultiversX Observer Nodes, providing:
- **Smart Routing (Data Partitioning)**: Forwards requests to the correct upstream gateway based on `epoch` or `nonce` parameters.
- **Access Control**: API key enforcement and User account management.
- **Rate Limiting**: Throttling based on user account tiers.
- **Usage Tracking**: Detailed metrics on request counts and performance.
- **User Dashboard**: A UI for managing keys and viewing status.

## 2. Architecture
The application follows a **Hexagonal Architecture** (Ports and Adapters) pattern, implemented in Go.

### Backend (`services/proxy`)
- **API Layer (`api/`)**: REST HTTP handlers using standard `net/http`. Handles authentication, request validation, and routing.
- **Process Layer (`process/`)**: Core business logic.
    - `HostsFinder`: The routing engine. It matches incoming request parameters (query params like `nonce` or `epoch`) against configured ranges (`StartEpoch`, `EndEpoch`, etc.) to select the correct upstream gateway.
    - `RequestsProcessor`: Orchestrates the request flow: Validate Auth -> Find Correct Host -> Forward Request.
    - `AccessChecker`: Enforces rate limits and account validity.
    - `SmtpSender`: Handles email notifications.
- **Storage Layer (`storage/`)**: Data persistence using **SQLite**.
- **Common (`common/`)**: Shared utilities and data structures.

### Frontend (`frontend/`)
A Single Page Application (SPA) built with:
- **Vite**: Build tool and dev server.
- **React**: UI library.
- **Tailwind CSS**: Utility-first styling.
- **Lucide React**: Iconography.
- **Axios**: HTTP client.

## 3. Data Model (SQLite)

### `users` Table
Stores user account information.
- `username` (Text, Primary Key): User's email address.
- `hashed_password` (Text): Bcrypt hashed password.
- `is_admin` (Boolean): Administrative privileges flag.
- `max_requests` (Integer): Total request limit (0 = Unlimited).
- `request_count` (Integer): Current usage counter.
- `account_type` (Text): 'free' or 'premium'.
- `is_active` (Boolean): Account activation status.
- `activation_token` (Text): Token for email verification.
- `pending_email` (Text): New email during email change process.
- `change_email_token` (Text): Token for email change verification.

### `access_keys` Table
Stores API keys generated by users.
- `key` (Text, Primary Key): The unique API key string (UUID or custom).
- `username` (Text, Foreign Key): Owner of the key.
- `request_count` (Integer): Usage counter specific to this key.

### `performance` Table
Stores system performance metrics.
- `label` (Text, Primary Key): Metric name (e.g., response time bucket).
- `counter` (Integer): Occurrence count.

## 4. API Endpoints

### Public
- `GET /app-info`: Returns application version and backend URL.
- `POST /api/login`: Authenticates a user and returns a JWT.
- `POST /api/register`: Registers a new user account.
- `GET /api/activate`: Activates a user account via token.
- `POST /api/request-email-change`: Initiates email change.
- `GET /api/confirm-email-change`: Finalizes email change.
- `GET /swagger/*`: Swagger UI documentation.
- `POST /captcha/request`: Request a new captcha.
- `GET /captcha/{id}.png`: Retrieve captcha image.

### Authenticated (Bearer Token)
- `GET /api/access-keys`: (Admin) List all keys.
- `POST /api/access-keys`: Create a new key.
- `DELETE /api/access-keys`: Revoke a key.
- `GET /api/admin-users`: (Admin) List all users.
- `POST /api/admin-users`: (Admin) Create a user.
- `PUT /api/admin-users`: (Admin) Update a user.
- `DELETE /api/admin-users`: (Admin) Delete a user.
- `GET /api/performance`: (Admin) Retrieve system performance metrics.
- `POST /api/change-password`: Change current user's password.

### Proxy Behaviour
- **Routing Logic**:
    - The proxy inspects incoming requests for specific query parameters: `nonce` or `epoch`.
    - It iterates through the configured `Gateways`, each having defined ranges (`NonceStart`-`NonceEnd`, `EpochStart`-`EpochEnd`).
    - The request is forwarded to the first Gateway where the requested `nonce` or `epoch` falls within its configured range.
    - If no parameters are provided, or if they don't match a specific range, the request may fall back to a "latest" gateway if configured.
    - If the target endpoint is in `ClosedEndpoints`, the request is rejected (404/403).
- **Rate Limiting**:
    - Checked against the `users` table using the provided Access Key.
    - Usage counters are incremented in SQLite for both the key and the user.

## 5. Configuration

### `config.toml`
- **Port**: Server listening port (default 8080).
- **Gateways**: Array of upstream MultiversX nodes (URL, Epoch range, Nonce range).
- **ClosedEndpoints**: JSON array of paths to block (e.g., transaction sending).
- **FreeAccount**: Default limits for free accounts (`MaxCalls`, `ClearPeriodInSeconds`).
- **AppDomains**: URLs for Backend and Frontend (used for email links/redirects).

### `.env`
- `JWT_KEY`: Secret for signing JWT tokens.
- `INITIAL_ADMIN_USER`: Username/Email for the bootstrap admin.
- `INITIAL_ADMIN_PASSWORD`: Password for the bootstrap admin.
- `INITIAL_ADMIN_KEY`: Initial API key for the bootstrap admin.
- `SMTP_HOST`: Mail server host.
- `SMTP_PORT`: Mail server port.
- `SMTP_FROM`: Sender email address.
- `SMTP_PASSWORD`: Sender email password.

## 6. Frontend Features (Dashboard)
- **Login/Registration**: Secure authentication flow.
- **Dashboard Home**:
    - **Keys Management**: View, copy, create, and delete API keys.
    - **User Management** (Admin): Table view of all users with edit/delete/create capabilities.
    - **Performance Graph** (Admin): Visual distribution of response times.
    - **Account Status** (User): View current limits and usage.
- **Settings**: Change password, update email.
- **Responsive Design**: Fully mobile-compatible UI using Glassmorphism aesthetics.

## 7. Future / In-Progress
- **Crypto Payment Service**: A scaffold for a `crypto-payment` service exists in the code references, intended to handle cryptocurrency payments for premium accounts. Currently in early development state.
